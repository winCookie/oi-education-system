# 博客系统 - 点赞和收藏状态修复说明

## 问题描述

用户反馈：刷新或重新进入已点赞/收藏的文章时，红色小心（点赞）和黄色书签（收藏）状态不显示，虽然点赞和收藏数量是正确的。

## 问题原因

后端 `getPostDetail` API 端点没有使用认证 Guard，导致即使前端发送了 JWT token，后端也无法解析用户信息，因此 `req.user` 为 `undefined`，无法正确返回 `isLiked` 和 `isFavorited` 状态。

## 修复方案

在 `blog.controller.ts` 的 `getPostDetail` 方法上添加 `@UseGuards(OptionalJwtAuthGuard)`，这样：
- 未登录用户仍可访问文章详情（`isLiked` 和 `isFavorited` 为 `false`）
- 已登录用户能正确获取自己的点赞和收藏状态

## 修改文件

### 后端文件

**文件**: `backend/src/modules/blog/blog.controller.ts`

**修改内容**:
1. 导入 `OptionalJwtAuthGuard`:
   ```typescript
   import { OptionalJwtAuthGuard } from '../auth/optional-jwt-auth.guard';
   ```

2. 在 `getPostDetail` 方法上添加 Guard:
   ```typescript
   @Get('posts/:id')
   @UseGuards(OptionalJwtAuthGuard)  // 新增
   async getPostDetail(@Param('id', ParseIntPipe) id: number, @Request() req) {
     const userId = req.user?.id;
     return this.blogService.getPostDetail(id, userId);
   }
   ```

## 技术细节

- `OptionalJwtAuthGuard` 是一个可选认证 Guard，允许未认证用户访问，但如果提供了有效的 JWT token，会解析并设置 `req.user`
- 后端 `blog.service.ts` 的 `getPostDetail` 方法已经正确实现了 `isLiked` 和 `isFavorited` 的查询逻辑
- 前端 `BlogDetail.tsx` 已经正确使用了 `post.isLiked` 和 `post.isFavorited` 来显示状态

## 部署步骤

由于修改了后端代码，需要重新构建并重启后端服务：

```bash
cd /Users/codewin/PythonWorkspace/oi-education-system
docker-compose build backend
docker-compose up -d backend
```

或者如果使用开发模式：

```bash
cd backend
npm run build
npm run start:prod
```

## 测试验证

修复后，请测试以下场景：

1. **未登录用户访问文章**：
   - 应该能正常查看文章
   - 点赞和收藏按钮显示为未激活状态（灰色）

2. **已登录用户访问未点赞/收藏的文章**：
   - 应该能正常查看文章
   - 点赞和收藏按钮显示为未激活状态（灰色）

3. **已登录用户访问已点赞/收藏的文章**：
   - 应该能正常查看文章
   - 点赞按钮显示为激活状态（红色背景，红色填充的心形图标）
   - 收藏按钮显示为激活状态（黄色背景，黄色填充的书签图标）

4. **刷新页面后状态保持**：
   - 已点赞/收藏的文章在刷新后，状态应该保持显示

## 修复日期

2026-01-26

## 相关文件

- `backend/src/modules/blog/blog.controller.ts` - 控制器修改
- `backend/src/modules/blog/blog.service.ts` - 服务层（无需修改，已正确实现）
- `backend/src/modules/auth/optional-jwt-auth.guard.ts` - 可选认证 Guard（已存在）
- `frontend/src/pages/BlogDetail.tsx` - 前端页面（无需修改，已正确实现）
- `frontend/src/api/client.ts` - API 客户端（无需修改，已正确配置 token 发送）
